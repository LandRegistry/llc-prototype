{% extends "layouts/main.html" %}

{% set serviceName= "Maintain LLC" %}

{% set pageName="Find a charge" %}
{% set selectHint = "" %}
{% set drawHint = "" %}
{% set editHint = "" %}
{% set deleteHint = "" %}
{% set snapHint = "" %}
{% set bodyClasses = "full-width" %}
{% set containerClasses = "full-width" %}


{% block beforeContent %}
{% include "includes/phase-banner.html" %}
{% include "includes/language-switcher-heading.html" %}
{% endblock %}

{% block content %}
<style>
  .govuk-width-container{
    max-width:99%;
    width:99%;
  }

  .charge{
    padding: 4px;
    border: 4px solid #fff;
  }

  .charge:hover{
    background-color: #ffdd00;
    border: 4px solid #0b0c0c;

  }
  .scroll{
    height: 720px;
    overflow-x: none;
    overflow-y: scroll;
    margin: 0;
  }
  .option-select{position:relative;padding:0 0 10px;margin-bottom:10px;border-bottom:1px solid #b1b4b6}@media(min-width: 48.0625em){.option-select ::-webkit-scrollbar{-webkit-appearance:none;width:7px}.option-select ::-webkit-scrollbar-thumb{border-radius:4px;background-color:rgba(0,0,0,.5);-webkit-box-shadow:0 0 1px rgba(255,255,255,.87)}}.option-select .gem-c-checkboxes{margin:0}.option-select__title{margin:0;font-family:"GDS Transport",arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-weight:400;font-size:1.1875rem;line-height:1.3157894737}@media print{.option-select__title{font-family:sans-serif}}@media print{.option-select__title{font-size:14pt;line-height:1.15}}.option-select__button{z-index:1;background:none;border:0;text-align:left;padding:0;cursor:pointer;color:#1d70b8}.option-select__button:hover{text-decoration:underline;text-underline-offset:.1em;text-decoration-thickness:max(3px, .1875rem, .12em);-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;text-decoration-skip:none}.option-select__button::-moz-focus-inner{border:0}.option-select__button:focus{outline:none;text-decoration:none;outline:3px solid rgba(0,0,0,0);color:#0b0c0c;background-color:#fd0;box-shadow:0 -2px #fd0,0 4px #0b0c0c;text-decoration:none;-webkit-box-decoration-break:clone;box-decoration-break:clone}.option-select__button[disabled]{background-image:none;color:inherit}.option-select__button::after{content:"";position:absolute;top:0;right:0;bottom:0;left:0;z-index:2}.option-select__icon{display:none;position:absolute;top:0;left:9px;width:30px;height:40px;fill:#0b0c0c}.option-select__container{position:relative;max-height:200px;overflow-y:auto;overflow-x:hidden;background-color:#fff}.option-select__container:focus{outline:0}.option-select__container--large{max-height:600px}.option-select__container-inner{padding:5px 13px}.option-select__filter{position:relative;background:#fff;padding:13px 13px 10px 13px}.option-select__filter-input{background:url(/assets/option-select/input-icon-f598506731e31889e6586357d63cf72be1c35e6bc255135fb4e48d4e9ed5e758.svg) #fff no-repeat -5px -3px;font-family:"GDS Transport",arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-weight:400;font-size:1.1875rem;line-height:1.3157894737}@media print{.option-select__filter-input{font-family:sans-serif}}@media print{.option-select__filter-input{font-size:14pt;line-height:1.15}}@media(min-width: 40.0625em){.option-select__filter-input{font-family:"GDS Transport",arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-weight:400;font-size:1rem;line-height:1.25}}@media print and (min-width: 40.0625em){.option-select__filter-input{font-family:sans-serif}}@media print and (min-width: 40.0625em){.option-select__filter-input{font-size:14pt;line-height:1.2}}.option-select__filter-input.govuk-input{padding-left:33px}.govuk-frontend-supported .option-select__heading{position:relative;padding:10px 8px 5px 43px;margin:0}.govuk-frontend-supported [aria-expanded=true]~.option-select__icon--up{display:block}.govuk-frontend-supported [aria-expanded=false]~.option-select__icon--down{display:block}.govuk-frontend-supported .option-select__container{height:200px}.govuk-frontend-supported .option-select__container--large{height:600px}.govuk-frontend-supported [data-closed-on-load=true] .option-select__container{display:none}.option-select__selected-counter{color:#0b0c0c;margin-top:3px;font-family:"GDS Transport",arial,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;font-weight:400;font-size:1rem;line-height:1.25}@media print{.option-select__selected-counter{font-family:sans-serif}}@media print{.option-select__selected-counter{font-size:14pt;line-height:1.2}}.option-select.js-closed .option-select__filter,.option-select.js-closed .option-select__container{display:none}.option-select.js-opened .option-select__filter,.option-select.js-opened .option-select__container{display:block}

  .govuk-grid-column-15-pc{
    width: 20%;
    box-sizing: border-box;
    padding: 0 15px;
    float: left;
  }
  .govuk-grid-column-three-quarters{
    width:80%;
  }
</style>
<!-- <h1 class="govuk-heading-l">Find a charge</h1> -->

<div id="container" class="govuk-grid-row">

  <div id="navbar" class="govuk-grid-column-15-pc scroll">

    <h2 class="govuk-heading-m">Find a charge</h2>

    {% include "./map-includes/search.html" %}

    {% include "./map-includes/map-controls-plus-none.html" %}

    <h2 class="govuk-heading-s">
      24 results
    </h2>   
      {% set categories = data.charges.categories %}
      {% include "./map-includes/filters.html" %}
      {% include "./map-includes/results.html" %}
    </div> 
    


  <div class="govuk-grid-column-three-quarters">

    <div style="position: relative; width: 0; height: 0">
        <br />
      <div class="nav-controls-fullwidth">
        <button id="zoom-in" class="zoom ol-zoom-in zoom-in" type="button" title="Zoom in">+<span class="govuk-visually-hidden">Zoom in</span></button>
        <button id="zoom-out" class="zoom ol-zoom-out zoom-out" type="button" title="Zoom out">-
          <span class="govuk-visually-hidden">Zoom out</span>
        </button>
      </div>
    </div>
    <div id="map" class="maintain-llc-map" tabindex="0" aria-label="Image showing search extent">
      <!-- <div class="center">
        <div class="horizontal"></div>
        <div class="vertical"></div>
      </div> -->
      <noscript>
        <div id="nojs" class="nojs-content">
          <div id="nojs-message" class="notification-summary">
            <p>
              You need to turn on JavaScript to use this service. Or, for assistance, please use the following link -
              <a id="“assistance-link”"
                href="https://customerhelp.landregistry.gov.uk/local-land-charges">https://customerhelp.landregistry.gov.uk/local-land-charges</a>
            </p>
          </div>
        </div>
      </noscript>
    </div>
    <div class=" govuk-!-padding-top-3 ">
      <div class="govuk-heading-s ">
        Map key

        <img class="map-key-image govuk-!-padding-left-3" src="/public/ol/images/information_available.png" alt="Location available key"
          height="19" width="19">
        <span class="map-key-text govuk-body-s">Location available</span>

        <img class="map-key-image govuk-!-padding-left-3" src="/public/ol/images/information_not_available.png"
          alt="Location not available key" height="19" width="19">
        <span class="map-key-text govuk-body-s">Location not available</span>

      </div>
    </div>

  </div>


</div>


<div class="govuk-grid-row">
  <div class="govuk-grid-column-three-quarters">

  </div>
</div>

{% endblock %}

{% block pageScripts %}
  <link rel=stylesheet media="screen, print" type=text/css href="/public/ol/css/maintain-frontend-custom.css">
  <link rel="stylesheet" href="/public/ol/css/ol.css" type="text/css">

  <!-- Jquery -->
  <script src="/public/ol/js/jquery.min.js"></script>


  <!-- Open Layers -->
  <script src="/public/ol/js/ol.js"></script>
  <script src="/public/ol/js/proj4.js"></script>
  <script src="/public/ol/js/union.js"></script>

  <!-- Custom Map Styles -->
  <script src="/public/ol/js/hatching_style.js"></script>
  <script src="/public/ol/js/map_styles.js"></script>
  
  <!-- Master Map Vector Layer -->
  <script src="/public/ol/js/master_map_vector_layer.js"></script>
  <script src="/public/ol/js/snap_to_vector_layer.js"></script>
  
  <!-- Custom Map Controls -->
  <script src="/public/ol/js/map_undo_v1.js"></script>
  <script src="/public/ol/js/map_controls.js"></script>
  <script src="/public/ol/js/map_helpers_v1.js"></script>
  
  <!-- Map config -->
  <script src="/public/ol/js/map_config.js"></script>


  <script id="option-select">

     $("#option-select-title-category").click(function(e){
      console.log('click');
      let content = $('#list_of_categories');
      if (this.getAttribute('aria-expanded') === 'false') {;
        this.setAttribute('aria-expanded', true);
        this.classList.add('app-c-expander__content--visible');
        content.css('display', 'block');

      } else {
        this.setAttribute('aria-expanded', false);
        this.classList.remove('app-c-expander__content--visible');
        content.css('display', 'none');
      }
    })

     $("#option-select-title-oa").click(function(e){
      console.log('click');
      let content = $('#list_of_oas');
      if (this.getAttribute('aria-expanded') === 'false') {;
        this.setAttribute('aria-expanded', true);
        this.classList.add('app-c-expander__content--visible');
        content.css('display', 'block');

      } else {
        this.setAttribute('aria-expanded', false);
        this.classList.remove('app-c-expander__content--visible');
        content.css('display', 'none');
      }
    })
     $("#option-select-postcode").click(function(e){
      console.log('click');
      let content = $('#postcodes');
      if (this.getAttribute('aria-expanded') === 'false') {;
        this.setAttribute('aria-expanded', true);
        this.classList.add('app-c-expander__content--visible');
        content.css('display', 'block');

      } else {
        this.setAttribute('aria-expanded', false);
        this.classList.remove('app-c-expander__content--visible');
        content.css('display', 'none');
      }
    })
     $("#option-select-reference").click(function(e){
      console.log('click');
      let content = $('#reference_number');
      if (this.getAttribute('aria-expanded') === 'false') {;
        this.setAttribute('aria-expanded', true);
        this.classList.add('app-c-expander__content--visible');
        content.css('display', 'block');

      } else {
        this.setAttribute('aria-expanded', false);
        this.classList.remove('app-c-expander__content--visible');
        content.css('display', 'none');
      }
    })
     $("#option-select-upload").click(function(e){
      console.log('click');
      let content = $('#uploads');
      if (this.getAttribute('aria-expanded') === 'false') {;
        this.setAttribute('aria-expanded', true);
        this.classList.add('app-c-expander__content--visible');
        content.css('display', 'block');

      } else {
        this.setAttribute('aria-expanded', false);
        this.classList.remove('app-c-expander__content--visible');
        content.css('display', 'none');
      }
    })
  </script>

  <script>   
    var termsLink = "";
    var mastermap_api_key = "{{ data.API_KEY }}";
    var map_base_layer_view_name = "m0100";
    var wfs_server_url = "{{ data.WFS_URL }}";
    var wmts_server_url = "{{ data.WMTS_URL }}";
  
    MAP_CONFIG.setBaseLayer(MAP_CONFIG.base_layer_zindex, MAP_CONFIG.mastermapResolutions, MAP_CONFIG.projection, termsLink, false);
  </script>
  
 
  <!-- OpenLayers Map -->
  <script src="/public/ol/js/map.js"></script>
  <script src="/public/ol/js/save_geometries.js"></script>

<script>
  // Add map controls: this is now only the scale line
  // controls are now GDS components
  var controls;

  MAP_HELPERS.init_controls(map, controls);
</script>


  <script type="text/javascript">
    $(function () {
      load_previous_data({ 
        "features":
        [
          {
            "geometry": 
            { "coordinates": [
                [
                  [532042.65, 181758.8], [532046.85, 181752.4], [532047.15, 181751.9], [532047.5, 181751.45], [532048.3, 181750.1], [532051.95, 181752.55], [532052.25, 181752.75], [532051.5, 181754.0], [532050.8, 181755.0], [532046.45, 181761.45], [532042.65, 181758.8]
                ]
              ], 
              "type": "Polygon"
            },
            "properties": { "id": 1000 }, 
            "type": "Feature"
          },
          {
            "geometry": 
            { "coordinates": [
                [
                  [532032.2, 181739.4], [532036.2, 181734.35], [532042.7, 181739.1], [532046.3, 181741.7], [532048.35, 181743.2], [532053.1, 181736.4], [532060.45, 181740.65], [532051.95, 181752.55], [532048.3, 181750.1], [532047.5, 181751.45], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532040.7, 181747.9], [532032.7, 181742.95], [532034.1, 181740.7], [532032.2, 181739.4]
                ]
              ], 
              "type": "Polygon"
            },
            "properties": { "id": 1001 }, 
            "type": "Feature"
          },
          {
            "geometry": 
            { "coordinates": [
                [
                  [532032.7, 181742.95], [532034.1, 181740.7], [532038.9, 181743.9], [532042, 181745.9], [532042.5, 181746.25], [532043.55, 181746.95], [532045.05, 181747.95], [532048.3, 181750.1], [532051.95, 181752.55], [532052.25, 181752.75], [532051.5, 181754], [532050.8, 181755], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532040.7, 181747.9], [532032.7, 181742.95]
                ] 
              ], 
              "type": "Polygon"
            },
            "properties": { "id": 1002 }, 
            "type": "Feature"
          },
          {
            "geometry": 
            { "coordinates": [
                [
                [532017.1, 181740.25], [532023.3, 181733.7], [532023.9, 181734.05], [532028.75, 181737.2], [532031.05, 181738.65], [532032.2, 181739.4], [532034.1, 181740.7], [532038.9, 181743.9], [532042, 181745.9], [532042.5, 181746.25], [532043.55, 181746.95], [532045.05, 181747.95], [532048.3, 181750.1], [532047.5, 181751.45], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532029.7, 181750.4], [532017.45, 181742.55], [532017.1, 181740.25]
                ] 
              ], 
              "type": "Polygon"
            },
            "properties": { "id": 1003 }, 
            "type": "Feature"
          },
          {
            "geometry": 
            { "coordinates": [
                [
                [532036.3, 181754.65], [532040.7, 181747.9], [532042, 181745.9], [532042.5, 181746.25], [532043.55, 181746.95], [532045.05, 181747.95], [532048.3, 181750.1], [532051.95, 181752.55], [532052.25, 181752.75], [532059.45, 181757.65], [532062.15, 181759.5], [532064.1, 181760.85], [532069.7, 181764.5], [532072.6, 181766.15], [532067.8, 181776.05], [532058.3, 181769.8], [532046.45, 181761.45], [532042.65, 181758.8], [532036.3, 181754.65]
                ] 
              ], 
              "type": "Polygon"
            },
            "properties": { "id": 1004 }, 
            "type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
                [532017.5, 181749.95], [532015.6, 181752.7], [532014.1, 181755], [532022.75, 181760.5], [532026.1, 181755.25], [532021.5, 181752.45], [532017.5, 181749.95]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1005 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532033.5, 181760.65], [532033, 181759.95], [532026.1, 181755.25], [532022.75, 181760.5], [532030.35, 181765.35], [532033.5, 181760.65]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1006 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532046.2283201754, 181768.87499999997], [532033.4443552631, 181760.64999999997], [532030.3797061403, 181765.19999999998], [532029.4165307017, 181767.12499999997], [532042.200495614, 181774.99999999997], [532046.2283201754, 181768.87499999997]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1007 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532051.95, 181792.9], [532059.05, 181791.5], [532065.3, 181781.4], [532054.6, 181774.3], [532046.3, 181768.85], [532042, 181775.2], [532040.85, 181775.5], [532036.35, 181782.95], [532044.8, 181788.4], [532051.95, 181792.9]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1008 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532058.3, 181769.8], [532062.65, 181763.15], [532064.1, 181760.85], [532069.7, 181764.5], [532072.6, 181766.15], [532067.8, 181776.05], [532058.3, 181769.8]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1009 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532062.65, 181763.15], [532064.1, 181760.85], [532062.15, 181759.5], [532059.45, 181757.65], [532052.25, 181752.75], [532051.5, 181754], [532050.8, 181755], [532046.45, 181761.45], [532058.3, 181769.8], [532062.65, 181763.15]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1010 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532042.65, 181758.8], [532046.85, 181752.4], [532047.15, 181751.9], [532047.5, 181751.45], [532048.3, 181750.1], [532051.95, 181752.55], [532052.25, 181752.75], [532051.5, 181754.0], [532050.8, 181755.0], [532046.45, 181761.45], [532042.65, 181758.8]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1011 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532042.5, 181746.25], [532042, 181745.9], [532040.7, 181747.9], [532036.3, 181754.65], [532042.65, 181758.8], [532046.85, 181752.4], [532047.5, 181751.45], [532048.3, 181750.1], [532045.05, 181747.95], [532043.55, 181746.95], [532042.5, 181746.25]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1012 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532040.7, 181747.9], [532032.7, 181742.95], [532034.1, 181740.7], [532032.2, 181739.4], [532031.05, 181738.65], [532029.25, 181741.45], [532026.95, 181740], [532028.75, 181737.2], [532023.9, 181734.05], [532023.3, 181733.7], [532017.1, 181740.25], [532017.45, 181742.55], [532029.7, 181750.4], [532036.3, 181754.65], [532040.7, 181747.9]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1013 },"type": "Feature"
          },
          {
            "geometry":{ "coordinates": [
              [
              [532036.3, 181754.65], [532040.7, 181747.9], [532032.7, 181742.95], [532034.1, 181740.7], [532031.05, 181738.65], [532029.25, 181741.45], [532026.95, 181740], [532023.1119005712, 181746.17823832517], [532036.3, 181754.65]
              ] 
            ], "type": "Polygon"},"properties": { "id": 1014 },"type": "Feature"
          }
        ],
        "type": "FeatureCollection"
      });
    });
  </script>
  
  <script>
  ///////////////////////////////////////////////
  // init select area
  ///////////////////////////////////////////////
  $( document ).ready(function() {

    // hack the map height
    let map_height = Math.floor($(window).height());
    $("#map").css("height", map_height);    
    $('.scroll').css('height', map_height);

    map.removeInteraction(MAP_CONTROLS.current_interaction);
    MASTER_MAP_VECTOR_LAYER.enable()
    MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.DRAW);
  
    MAP_CONTROLS.current_interaction = new ol.interaction.Select({
      layers: [MASTER_MAP_VECTOR_LAYER.layer],
      style: draw_layer_styles.style[draw_layer_styles.DRAW]
    });
  
    MAP_CONTROLS.current_interaction.getFeatures().on('add', function (event) {
      MAP_UNDO.store_state();
      feature = event.target.item(0).clone();
      if (feature) {
        geometry = feature.getGeometry();
        //Convert multi polygons to features
        if (geometry instanceof ol.geom.MultiPolygon) {
          geometry.getPolygons().forEach(function (geometry) {
            MAP_CONTROLS.addGeometryToMap(geometry)
          })
        }
        else {
          MAP_CONTROLS.addGeometryToMap(geometry)
        }
      }
    });
  
    MAP_CONTROLS.vectorControls.copy_enabled = true;
    map.addInteraction(MAP_CONTROLS.current_interaction);

    // hack the nav buttons
    let map_width = Math.floor($('#map').width());
    $(".nav-controls-fullwidth").css("left", map_width - 140);

    //zoom out to hack bounds box
/*     const view = map.getView();
    const zoom = view.getZoom();
     view.animate({
      zoom: (zoom - 1),
      duration: 0
    }); */

    // add hover event
    //.hover(inFunction,outFunction) 
    let current_hover = 0;
    $('.charge').hover(
      function(){
        console.log('over');
        
        current_hover = $(this)[0].id.split("_")[1];
        current_hover = parseInt(current_hover);
        //get feature by id
        var features = MAP_CONFIG.draw_source.getFeatures();
        
        //set highlight
        features[current_hover].setStyle(draw_layer_styles.style[draw_layer_styles.HIGHLIGHT]);
    },
    function(){
      console.log('out');
      //get feature by id
      var features = MAP_CONFIG.draw_source.getFeatures();
      //var feature = $.grep(features, function(feature) { return feature.getProperties().id == id });
      //set highlight
      features[current_hover].setStyle(draw_layer_styles.style[draw_layer_styles.NONE]);
    }
  )
  });
  
</script>

<script type="text/javascript">
  var center = [];

  function checkZoom() {
    const view = map.getView();
    const zoom = view.getZoom();

    if (zoom < 12) {
      $("#select").prop('disabled', 'true');
      // if select was checked, uncheck it and set as draw
      if ($("#select").prop('checked') == true) {
        $("#draw").prop('checked', 'true');
      }

      $("#snap_to_map").prop('disabled', 'true');
    } else {
      $("#select").removeAttr("disabled");
      $("#snap_to_map").removeAttr("disabled");
    }

    //reset the controls
    setMode();
  }


  map.on('moveend', checkZoom);
  
  document.getElementById('zoom-out').onclick = function () {
    console.log('click OUT');
    checkZoom();
    const view = map.getView();
    const zoom = view.getZoom();
    view.animate({
      zoom: (zoom - 1),
      duration: 300
    });
  };
    
  document.getElementById('zoom-in').onclick = function () {
    console.log('click IN');
    checkZoom();
    const view = map.getView();
    const zoom = view.getZoom();
    view.animate({
      zoom: (zoom + 1),
      duration: 300
    });
  };
    
/*   document.getElementById('fullscreen').onclick = function () {
    window.open("fullscreen", "_self");
  }; */

  document.getElementById('clearAllBtn').onclick = function () {
    map.removeInteraction(MAP_CONTROLS.current_interaction);
    MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.NONE)
    MAP_CONFIG.draw_source.clear();
    setMode();
  };

  document.getElementById('undoBtn').onclick = function () {
    MAP_UNDO.undo();
    setMode();
  };


  $(document).on("change", "input[type=radio]", function () {
    setMode();
  });


  function setMode(){
    var radio = $('[name="edit-mode"]:checked').val();
    map.removeInteraction(MAP_CONTROLS.hover_interaction);
    console.log(radio);
    //hide cross hair
    $('.center').addClass('govuk-visually-hidden');

    if (radio == "none") {
      $('.center').removeClass('govuk-visually-hidden');
      map.removeInteraction(MAP_CONTROLS.current_interaction);
      MASTER_MAP_VECTOR_LAYER.enable()
      MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.NONE);

      MAP_CONTROLS.current_interaction = new ol.interaction.Select({
        // NB set the selection to the draw layer to read the id
        layers: [MAP_CONFIG.draw_layer],
        style: draw_layer_styles.style[draw_layer_styles.NONE]
      });

    }

    if (radio == "draw-area" || radio == "cutout-area" || radio == "add-line") {
      map.removeInteraction(MAP_CONTROLS.current_interaction);
      MASTER_MAP_VECTOR_LAYER.enable()
      MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.DRAW);

      MAP_CONTROLS.add_draw_interaction("Polygon", $('#' + MAP_CONTROLS.addAreaButtonId));
    }

    if (radio == "select-area" || radio == "add-circle" || radio == "add-point") {
      $('.center').removeClass('govuk-visually-hidden');
      map.removeInteraction(MAP_CONTROLS.current_interaction);
      MASTER_MAP_VECTOR_LAYER.enable()
      MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.DRAW);

      MAP_CONTROLS.current_interaction = new ol.interaction.Select({
        layers: [MASTER_MAP_VECTOR_LAYER.layer],
        style: draw_layer_styles.style[draw_layer_styles.DRAW]
      });

      // ADD hover functionality
      MAP_CONTROLS.hover_interaction = new ol.interaction.Select({
      condition: ol.events.condition.pointerMove,
        style: draw_layer_styles.style[draw_layer_styles.HOVER]
      });
      map.addInteraction(MAP_CONTROLS.hover_interaction);

      MAP_CONTROLS.current_interaction.getFeatures().on('add', function (event) {
        MAP_UNDO.store_state();
        feature = event.target.item(0).clone();
        if (feature) {
          geometry = feature.getGeometry();
          //Convert multi polygons to features
          if (geometry instanceof ol.geom.MultiPolygon) {
            geometry.getPolygons().forEach(function (geometry) {
              MAP_CONTROLS.addGeometryToMap(geometry)
            })
          }
          else {
            MAP_CONTROLS.addGeometryToMap(geometry)
          }
        }
      });

      MAP_CONTROLS.vectorControls.copy_enabled = true;
      map.addInteraction(MAP_CONTROLS.current_interaction);
    }

    if (radio == "edit-area") {
      map.removeInteraction(MAP_CONTROLS.current_interaction);

        MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.EDIT);

        MAP_CONTROLS.current_interaction = new ol.interaction.Modify({
          features: MAP_CONFIG.draw_features,
          style: draw_layer_styles.style[draw_layer_styles.EDIT]
        });

        map.addInteraction(MAP_CONTROLS.current_interaction);
        $("#" + MAP_CONTROLS.editButtonId).trigger("edit:toggled");
        if (MAP_CONTROLS.vectorControls.snap_to_enabled) {
          map.addInteraction(snap_to_interaction)
        }

        MAP_CONTROLS.current_interaction.on('modifystart', function (event) {
          MAP_UNDO.store_state();
        });

    }


    if (radio == "delete-area") {
      $('.center').removeClass('govuk-visually-hidden');
      map.removeInteraction(MAP_CONTROLS.current_interaction);

        MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.REMOVE);

        MAP_CONTROLS.current_interaction = new ol.interaction.Select({
          layers: [MAP_CONFIG.draw_layer]
        });

        MAP_CONTROLS.current_interaction.getFeatures().on('add', function (event) {
          var feature_id = event.element.getProperties().id;
console.log(feature_id);

          MAP_CONTROLS.remove_selected_feature(feature_id);
          MAP_CONTROLS.current_interaction.getFeatures().clear();
        });

        map.addInteraction(MAP_CONTROLS.current_interaction)

    }

  };

  // Not sure about this - vector snap also depends on zoom level
  // this is because we can only load in a set number of polygons to use for the 'snap'
  $('#snap_to_map').change(function () {
    MAP_CONTROLS.vectorControls.snap_to_enabled = $(this).is(':checked');

    if (MAP_CONTROLS.vectorControls.snap_to_enabled) {
      // Enable the snap to interaction and vector layer
      SNAP_TO_VECTOR_LAYER.enable()
      map.addInteraction(snap_to_interaction)
      MAP_CONTROLS.vectorControls.snap_to_enabled = true
    } else {
      // Disable the snap to interaction and vector layer, but not the snap to button
      // Don't disable vector layer if copy active
      if (!MAP_CONTROLS.vectorControls.copy_enabled) {
        SNAP_TO_VECTOR_LAYER.disable()
      }
      map.removeInteraction(snap_to_interaction)
      MAP_CONTROLS.vectorControls.snap_to_enabled = false
    }
  });

  $('#hatching').change(function () {
    showHatching = $(this).is(':checked');
    MAP_CONTROLS.toggle_draw_layer_style(MAP_CONTROLS.current_style);
  });

/*   document.getElementById('select-centre').onclick = function (evt) {
    var radio = $('[name="edit-mode"]:checked').val();

    if (radio == "draw-area" || radio == "select-area") {
        selectCentre(evt)
    }
    if (radio == "delete-area") {
      console.log('delete');
      deleteCentre(evt);
    }
  }; */


  function selectCentre(evt){
    console.log('x');
    // get centre of map
    let center = getCenterCoords();
    // get polygon at those coords
    MASTER_MAP_VECTOR_LAYER.enable();
    MAP_UNDO.store_state();
    var source = MASTER_MAP_VECTOR_LAYER.layer.getSource();
    var features = source.getFeatures();
    var feature = source.getFeaturesAtCoordinate(center)[0];

    if (feature) {
      geometry = feature.getGeometry();
      MAP_CONTROLS.addGeometryToMap(geometry)
    }
    MASTER_MAP_VECTOR_LAYER.disable();

    setMode();
  };


  function deleteCentre(evt){
    // the app creates a drawn layer with the selected polygons, with a timestamp id
    // to remove a polygon, get the feature that contains the centre coords, get it's id and remove it
    console.log('delete');
    // get centre of map
    let center = getCenterCoords();
    // get polygon of the drawn layer at those coords
    var source = MAP_CONFIG.draw_layer.getSource();
    var features = source.getFeatures();
    var feature = source.getFeaturesAtCoordinate(center)[0];

    if (feature) {
      console.log('got feature');
      var feature_id = feature.getProperties().id;
      MAP_CONTROLS.remove_selected_feature(feature_id);
    }

    setMode();
  };

  function getCenterCoords() {
    center = map.getView().getCenter(map.getSize());
    console.log(center);
    return center;
  }
</script>

<script>
  //////////////////////////////////////////////////////////////////////
  // button pixel panning 
  ////////////////////////////////////////////////////////////////////// 
  const step = 10; // pixels
  function moveMap([xDirection, yDirection]) {
    var center = map.getView().getCenter();
    var resolution = map.getView().getResolution();
    map.getView().setCenter([center[0] + xDirection * resolution, center[1] + yDirection * resolution]);
  }

/*   document.getElementById('pan-up').onclick = function () {
    moveMap([0, step]);
  };
  document.getElementById('pan-left').onclick = function () {
    moveMap([-step, 0]);
  };
  document.getElementById('pan-right').onclick = function () {
    moveMap([step, 0]);
  };
  document.getElementById('pan-down').onclick = function () {
    moveMap([0, -step]);
  }; */
</script>

<script>
  //////////////////////////////////////////////////////////////////////
  // key pixel panning: Arrows and space bar
  ////////////////////////////////////////////////////////////////////// 
  const step_by_key = 10; // pixels

  function moveMap([xDirection, yDirection]) {
    var center = map.getView().getCenter();
    var resolution = map.getView().getResolution();
    //map.getView().setCenter([center[0] + xDirection * resolution, center[1] + yDirection * resolution]);
    let coords = [center[0] + xDirection * resolution, center[1] + yDirection * resolution];
    let view = map.getView();
    let zoom = view.getZoom();
    view.animate({
            center: coords,
            duration: 100
          });
  }

  document.getElementById('map').addEventListener("keydown", (evt) => {
    console.log(evt.key);
    evt.stopPropagation();
    let view = map.getView();
    let zoom = view.getZoom();
    if(evt.altKey || evt.shiftKey){
      switch (evt.key) {
        case "w":
        case "ArrowUp":
        moveMap([0, step_by_key]);
          break;
        case "ArrowLeft":
        moveMap([-step_by_key, 0]);
          break;
        case "ArrowRight":
        moveMap([step_by_key, 0]);
          break;
        case "ArrowDown":
        moveMap([0, -step_by_key]);
          break;
        case "ArrowDown":
        moveMap([0, -step_by_key]);
          break;
        case "+":
          view.animate({
            zoom: (zoom + 1),
            duration: 300
          });
          break;
        case "_":
          view.animate({
            zoom: (zoom - 1),
            duration: 300
          });
          break;
        default:
          break;
      } 
    } else {

      switch(evt.key) {
        case "w":
        moveMap([0, step_by_key*13]);
          break;
        case "a":
        moveMap([-step_by_key*13, 0]);
          break;
        case "d":
        moveMap([step_by_key*13, 0]);
          break;
        case "s":
        moveMap([0, -step_by_key*13]);
          break;
        case "e":
        case "=":
          view.animate({
            zoom: (zoom + 1),
            duration: 300
          });
          break;
        case "q":
        case "_":
          view.animate({
            zoom: (zoom - 1),
            duration: 300
          });
          break;
          }
      }

    var code = event.charCode || event.keyCode;
    if((code === 32)|| (code === 13)){ // space (32)or Enter (13)
      event.preventDefault();
      var radio = $('[name="edit-mode"]:checked').val();

        if (radio == "draw-area" || radio == "select-area") {
            selectCentre(evt)
        }
        if (radio == "delete-area") {
          console.log('delete');
          deleteCentre(evt);
        }
    }

  });

  $( window ).on( "resize", function() {
    let map_width = Math.floor($('#map').width());
    $(".nav-controls-fullwidth").css("left", map_width - 140);
    //let ht = $( window ).height()
    //$(".scroll").css("height", ht - 140);
    //console.log('ht', ht);

  } );

</script>
{% endblock %}