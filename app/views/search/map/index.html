{% extends "layouts/main.html" %}

{% set serviceName= "Maintain LLC" %}
{% set pageName="Add a charge" %}

{% set bodyClasses = "full-width" %}
{% set containerClasses = "full-width" %}

{% block content %}

<div id="container" class="govuk-grid-row">
  <!--  NAVIGATION  -->
  <div id="navbar" class="govuk-grid-column-20-percent scroll">
    <a class="govuk-back-link" href="javascript: history.go(-1)">Back</a>
    <h2 class="govuk-heading-m">Add an extent</h2>

    {% include "./includes/postcode-search.html" %}

    <p class="govuk-body">
      <ul class="govuk-list">
        <li><a href="search-by-upload" class="govuk-link govuk-link--no-visited-state">Add an extent by uploading a shapefile</a></li>
        <li><a href="search-by-title" class="govuk-link govuk-link--no-visited-state">Add an extent by title number</a></li>
      </ul>
    </p>

    {% include "./includes/controls.html" %}

    {% include "./includes/help.html" %}

    {% include "./includes/footer.html" %}

  </div> 
    

  <!-- MAP  -->
  <div class="govuk-grid-column-three-quarters">

    <div style="position: relative; width: 0; height: 0">
        <br />
      <div class="nav-controls-fullwidth">
        <button id="zoom-in" class="zoom ol-zoom-in zoom-in" type="button" title="Zoom in">+<span class="govuk-visually-hidden">Zoom in</span></button>
        <button id="zoom-out" class="zoom ol-zoom-out zoom-out" type="button" title="Zoom out">-
          <span class="govuk-visually-hidden">Zoom out</span>
        </button>
      </div>
    </div>
    <div id="map" class="maintain-llc-map" tabindex="0" aria-label="Image showing search extent">
      <!-- <div class="center">
        <div class="horizontal"></div>
        <div class="vertical"></div>
      </div> -->
      <noscript>
        <div id="nojs" class="nojs-content">
          <div id="nojs-message" class="notification-summary">
            <p>
              You need to turn on JavaScript to use this service. Or, for assistance, please use the following link -
              <a id="“assistance-link”"
                href="https://customerhelp.landregistry.gov.uk/local-land-charges">https://customerhelp.landregistry.gov.uk/local-land-charges</a>
            </p>
          </div>
        </div>
      </noscript>
    </div>
    <div class=" govuk-!-padding-top-2">
      <div class="govuk-heading-s ">
        Map key

        <img class="key-image govuk-!-padding-left-3" src="/public/ol/images/information_available.png" alt="Location available key"
          height="19" width="19">
        <span class="key-text govuk-body-s">Location available</span>

        <img class="key-image govuk-!-padding-left-3" src="/public/ol/images/information_not_available.png"
          alt="Location not available key" height="19" width="19">
        <span class="key-text govuk-body-s">Location not available</span>

        <span class="govuk-body-s align-right">
          Use of address and mapping data is subject to <a href="#" target="_blank">Ordnance Survey terms and conditions</a>
        </span>
      </div>
    </div>

  </div>


</div>


<div class="govuk-grid-row">
  <div class="govuk-grid-column-three-quarters">

  </div>
</div>

{% endblock %}

{% block pageScripts %}
  <link rel=stylesheet href="/public/ol/css/maintain-frontend-custom.css"type="text/css" >
  <!--  Custom map styles for this page -->
  <link rel="stylesheet" href="/public/css/map-styles.css">

  <!-- Jquery -->
  <script src="/public/ol/js/jquery.min.js"></script>

  <!-- Open Layers -->
  <script src="/public/ol/js/ol.js"></script>
  <script src="/public/ol/js/proj4.js"></script>
  <script src="/public/ol/js/union.js"></script>

  <!-- Custom Map Styles -->
  <script src="/public/ol/js/hatching_style.js"></script>
  <script src="/public/ol/js/map_styles.js"></script>
  
  <!-- Master Map Vector Layer -->
  <!--------  NB HACK TO FIX THE MASTER MAP SOURCE  -------->
  <script src="/public/ol/js/master_map_vector_layer_fixed.js"></script>
  <script src="/public/ol/js/snap_to_vector_layer.js"></script>
  
  <!-- Custom Map Controls -->
  <script src="/public/ol/js/map_undo_v1.js"></script>
  <script src="/public/ol/js/map_controls.js"></script>
  <script src="/public/ol/js/map_helpers_v1.js"></script>
  
  <!-- Map config -->
  <script src="/public/ol/js/map_config.js"></script>


  <script>   
    var termsLink = "";
    var mastermap_api_key = "{{ data.API_KEY }}";
    var map_base_layer_view_name = "m0100";
    var wfs_server_url = "{{ data.WFS_URL }}";
    var wmts_server_url = "{{ data.WMTS_URL }}";
  
    MAP_CONFIG.setBaseLayer(MAP_CONFIG.base_layer_zindex, MAP_CONFIG.mastermapResolutions, MAP_CONFIG.projection, termsLink, false);
  </script>
  
   <!-- OpenLayers Map (Note: must be after the key config) -->
  <script src="/public/ol/js/map.js"></script>
  <script src="/public/ol/js/save_geometries.js"></script>
  <script src="/public/ol/js/keyboard_panning.js"></script>

  
<script>
  // Add map controls: this is now only the scale line
  // controls are now GDS components
  var controls;

  MAP_HELPERS.init_controls(map, controls);
</script>


  <script type="text/javascript">
    // use this to prepopulate with an extent
    // or in this case to set the initial map bounds
    $(function () {
      load_previous_data({ "features": [{ "geometry": { "coordinates": [[[532042.65, 181758.8]]], "type": "Polygon" }, "properties": { "id": 1696925633279 }, "type": "Feature" }], "type": "FeatureCollection" });
    });
  </script>
  
  <script>
  ///////////////////////////////////////////////
  // init select area
  ///////////////////////////////////////////////
  $( document ).ready(function() {

    // hack the map height
    let page_height = Math.floor($(window).height());
    $("#map").css("height", page_height - 130);    
    $("#container").css("height", page_height - 120);    
    $('.scroll').css('height', page_height - 70);
    // hack the nav buttons
    let map_width = Math.floor($('#map').width());
    $(".nav-controls-fullwidth").css("left", map_width - 140);
    
    //hide the postcode list
    $('#address-list').hide();
    $('#selected-address').hide();
    $('#results-heading').hide();
    $('#results-guide').hide();
    //hide the results charge list
    $('.results-title').hide();
    $('.results').hide();

    // trigger map resize
    window.dispatchEvent(new Event('resize'));

    // add map event listeners to hide Select area hover state on mouseout
    map.getViewport().addEventListener('mouseover', function(event){
        MASTER_MAP_VECTOR_LAYER.enable()
    }, false);
    map.getViewport().addEventListener('mouseout', function(event){
        MASTER_MAP_VECTOR_LAYER.disable()
    }, false);


    map.removeInteraction(MAP_CONTROLS.current_interaction);
    MASTER_MAP_VECTOR_LAYER.enable()
    MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.DRAW);
  
    MAP_CONTROLS.current_interaction = new ol.interaction.Select({
      layers: [MASTER_MAP_VECTOR_LAYER.layer],
      style: draw_layer_styles.style[draw_layer_styles.DRAW]
    });
  
    MAP_CONTROLS.current_interaction.getFeatures().on('add', function (event) {
      MAP_UNDO.store_state();
      feature = event.target.item(0).clone();
      if (feature) {
        geometry = feature.getGeometry();
        //Convert multi polygons to features
        if (geometry instanceof ol.geom.MultiPolygon) {
          geometry.getPolygons().forEach(function (geometry) {
            MAP_CONTROLS.addGeometryToMap(geometry)
          })
        }
        else {
          MAP_CONTROLS.addGeometryToMap(geometry)
        }
      }
    });
  
    MAP_CONTROLS.vectorControls.copy_enabled = true;
    map.addInteraction(MAP_CONTROLS.current_interaction);

    MAP_CONTROLS.vectorControls.snap_to_enabled = true;
    // Enable the snap to interaction and vector layer
    SNAP_TO_VECTOR_LAYER.enable();
    map.addInteraction(snap_to_interaction);

    //zoom out to hack bounds box
    const view = map.getView();
    const zoom = view.getZoom();
    view.animate({
      zoom: (zoom - 4),
      duration: 0
    });
  });
  
</script>

<script type="text/javascript">
  var center = [];

  function checkZoom() {
    const view = map.getView();
    const zoom = view.getZoom();

    if (zoom < 12 && zoom > 0) { //stops the check disabling select-area at start
      $("#select").prop('disabled', 'true');
      // if select was checked, uncheck it and set as draw
      if ($("#select").prop('checked') == true) {
        $("#draw").prop('checked', 'true');
      }
      // disable snap to map when zoomed out
      $("#snap_to_map").prop('disabled', 'true');
      $("#snap_to_map").prop('checked', false)
    } else {
      $("#select").removeAttr("disabled");
      // enable snap to map when zoomed out
      $("#snap_to_map").removeAttr("disabled");

      $("#snap_to_map").prop('checked', userSetSnapToMap)
    }

    //reset the controls
    setMode();
  }


  map.on('moveend', checkZoom);
  
  document.getElementById('zoom-out').onclick = function () {
    console.log('click OUT');
    checkZoom();
    const view = map.getView();
    const zoom = view.getZoom();
    view.animate({
      zoom: (zoom - 1),
      duration: 300
    });
  };
    
  document.getElementById('zoom-in').onclick = function () {
    console.log('click IN');
    checkZoom();
    const view = map.getView();
    const zoom = view.getZoom();
    view.animate({
      zoom: (zoom + 1),
      duration: 300
    });
  };
    
/*   document.getElementById('fullscreen').onclick = function () {
    window.open("fullscreen", "_self");
  }; */

  document.getElementById('clearAllBtn').onclick = function () {
    map.removeInteraction(MAP_CONTROLS.current_interaction);
    MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.NONE)
    MAP_CONFIG.draw_source.clear();
    setMode();
  };

  document.getElementById('undoBtn').onclick = function () {
    MAP_UNDO.undo();
    setMode();
  };

  $(document).on("change", "input[type=radio]", function () {
    setMode();
  });


  function setMode(){
    var radio = $('[name="edit-mode"]:checked').val();
    map.removeInteraction(MAP_CONTROLS.hover_interaction);
    console.log(radio);
    //hide cross hair
    $('.center').addClass('govuk-visually-hidden');

    if (radio == "draw-area" || radio == "cutout-area" || radio == "add-line") {
      map.removeInteraction(MAP_CONTROLS.current_interaction);
      MASTER_MAP_VECTOR_LAYER.enable()
      MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.DRAW);

      MAP_CONTROLS.add_draw_interaction("Polygon", $('#' + MAP_CONTROLS.addAreaButtonId));
    }

    if (radio == "select-area" || radio == "add-circle" || radio == "add-point") {
      $('.center').removeClass('govuk-visually-hidden');
      map.removeInteraction(MAP_CONTROLS.current_interaction);
      MASTER_MAP_VECTOR_LAYER.enable()
      MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.DRAW);

      MAP_CONTROLS.current_interaction = new ol.interaction.Select({
        layers: [MASTER_MAP_VECTOR_LAYER.layer],
        style: draw_layer_styles.style[draw_layer_styles.DRAW]
      });

      // ADD hover functionality
      MAP_CONTROLS.hover_interaction = new ol.interaction.Select({
      condition: ol.events.condition.pointerMove,
        style: draw_layer_styles.style[draw_layer_styles.HOVER]
      });
      map.addInteraction(MAP_CONTROLS.hover_interaction);

      MAP_CONTROLS.current_interaction.getFeatures().on('add', function (event) {
        MAP_UNDO.store_state();
        feature = event.target.item(0).clone();
        if (feature) {
          geometry = feature.getGeometry();
          //Convert multi polygons to features
          if (geometry instanceof ol.geom.MultiPolygon) {
            geometry.getPolygons().forEach(function (geometry) {
              MAP_CONTROLS.addGeometryToMap(geometry)
            })
          }
          else {
            MAP_CONTROLS.addGeometryToMap(geometry)
          }
        }
      });

      MAP_CONTROLS.vectorControls.copy_enabled = true;
      map.addInteraction(MAP_CONTROLS.current_interaction);
    }

    if (radio == "edit-area") {
      map.removeInteraction(MAP_CONTROLS.current_interaction);

        MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.EDIT);

        MAP_CONTROLS.current_interaction = new ol.interaction.Modify({
          features: MAP_CONFIG.draw_features,
          style: draw_layer_styles.style[draw_layer_styles.EDIT]
        });

        map.addInteraction(MAP_CONTROLS.current_interaction);
        $("#" + MAP_CONTROLS.editButtonId).trigger("edit:toggled");
        if (MAP_CONTROLS.vectorControls.snap_to_enabled) {
          map.addInteraction(snap_to_interaction)
        }

        MAP_CONTROLS.current_interaction.on('modifystart', function (event) {
          MAP_UNDO.store_state();
        });

    }


    if (radio == "delete-area") {
      $('.center').removeClass('govuk-visually-hidden');
      map.removeInteraction(MAP_CONTROLS.current_interaction);

        MAP_CONTROLS.toggle_draw_layer_style(draw_layer_styles.REMOVE);

        MAP_CONTROLS.current_interaction = new ol.interaction.Select({
          layers: [MAP_CONFIG.draw_layer]
        });

        MAP_CONTROLS.current_interaction.getFeatures().on('add', function (event) {
          var feature_id = event.element.getProperties().id;

          MAP_CONTROLS.remove_selected_feature(feature_id);
          MAP_CONTROLS.current_interaction.getFeatures().clear();
        });

        map.addInteraction(MAP_CONTROLS.current_interaction)

    }

  };

  // Not sure about this - vector snap also depends on zoom level
  // this is because we can only load in a set number of polygons to use for the 'snap'
  let userSetSnapToMap = true;
  $('#snap_to_map').change(function () {
    MAP_CONTROLS.vectorControls.snap_to_enabled = $(this).is(':checked');
    userSetSnapToMap = $(this).is(':checked');
   
    if (MAP_CONTROLS.vectorControls.snap_to_enabled) {
      // Enable the snap to interaction and vector layer
      SNAP_TO_VECTOR_LAYER.enable();
      map.addInteraction(snap_to_interaction);
      MAP_CONTROLS.vectorControls.snap_to_enabled = true;
    } else {
      // Disable the snap to interaction and vector layer, but not the snap to button
      // Don't disable vector layer if copy active
      if (!MAP_CONTROLS.vectorControls.copy_enabled) {
        SNAP_TO_VECTOR_LAYER.disable();
      }
      map.removeInteraction(snap_to_interaction);
      MAP_CONTROLS.vectorControls.snap_to_enabled = false;
    }
  });

  function selectCentre(evt){
    console.log('x');
    // get centre of map
    let center = getCenterCoords();
    // get polygon at those coords
    MASTER_MAP_VECTOR_LAYER.enable();
    MAP_UNDO.store_state();
    var source = MASTER_MAP_VECTOR_LAYER.layer.getSource();
    var features = source.getFeatures();
    var feature = source.getFeaturesAtCoordinate(center)[0];

    if (feature) {
      geometry = feature.getGeometry();
      MAP_CONTROLS.addGeometryToMap(geometry)
    }
    MASTER_MAP_VECTOR_LAYER.disable();

    setMode();
  };


  function deleteCentre(evt){
    // the app creates a drawn layer with the selected polygons, with a timestamp id
    // to remove a polygon, get the feature that contains the centre coords, get it's id and remove it
    console.log('delete');
    // get centre of map
    let center = getCenterCoords();
    // get polygon of the drawn layer at those coords
    var source = MAP_CONFIG.draw_layer.getSource();
    var features = source.getFeatures();
    var feature = source.getFeaturesAtCoordinate(center)[0];

    if (feature) {
      console.log('got feature');
      var feature_id = feature.getProperties().id;
      MAP_CONTROLS.remove_selected_feature(feature_id);
    }

    setMode();
  };

  function getCenterCoords() {
    center = map.getView().getCenter(map.getSize());
    console.log(center);
    return center;
  }
</script>


<script>
  $( window ).on( "resize", function() {
    let map_width = Math.floor($('#map').width());
    $(".nav-controls-fullwidth").css("left", map_width - 140);
    //let ht = $( window ).height()
    //$(".scroll").css("height", ht - 140);
    //console.log('ht', ht);

  } );

  ///////////////////////////////////////////////
  // postcode / address check
  ///////////////////////////////////////////////
  $("#find-btn").click(function(e){
    $('#address-list').show();
    $('#selected-address').hide();
    $('#results-heading').show();
    $("#postcodes").css("height", 400);   
  });  
  
  $("li a").click(function(e){
    console.log(this.text);
    $('#address-list').hide();
    $("#postcodes").css("height", 240); 
    $('#selected-address').html("This is the map for:<br/>" + this.text);
    $('#selected-address').show();
    $('#results-heading').hide();
    $('#results-guide').show();

    const view = map.getView();
    const zoom = view.getZoom();

    let coords =[532050, 181750];
      view.animate({
        center: coords,
        zoom: (zoom + 3),
        duration: 0
      }); 
/*     view.animate({
      zoom: (zoom + 3),
      duration: 0
    }); */


    console.log(this.text.substr(0, 3));


    if (this.text.substr(0, 3) === "5-6"){
      console.log('*** show area ****');
      
      load_previous_data({ "features": [{ "geometry": { "coordinates": [
        [
          //[532017.1, 181740.25], [532023.3, 181733.7], [532023.9, 181734.05], [532028.75, 181737.2], [532031.05, 181738.65], [532032.2, 181739.4], [532034.1, 181740.7], [532038.9, 181743.9], [532042, 181745.9], [532042.5, 181746.25], [532043.55, 181746.95], [532045.05, 181747.95], [532048.3, 181750.1], [532047.5, 181751.45], [532046.85, 181752.4], [532042.65, 181758.8], [532036.3, 181754.65], [532029.7, 181750.4], [532017.45, 181742.55], [532017.1, 181740.25]
          //5 - 6
          [532017.1, 181740.25], [532023.3, 181733.7], [532023.9, 181734.05], [532028.75, 181737.2], [532031.05, 181738.65], [532032.2, 181739.4], [532034.1, 181740.7], [532038.9, 181743.9], [532042.0, 181745.9], [532040.7, 181747.9], [532036.3, 181754.65], [532029.7, 181750.4], [532017.45, 181742.55], [532017.1, 181740.25]
        ] 
      ], "type": "Polygon" }, "properties": { "id": 1696925633279 }, "type": "Feature" }], "type": "FeatureCollection" });

      //update continue button url
      $("#continueButton").attr("href", "singular-address-56")
    }

    MAP_CONTROLS.vectorControls.snap_to_enabled = $('#snap_to_map').is(':checked');
    SNAP_TO_VECTOR_LAYER.enable();
    map.addInteraction(snap_to_interaction);
  });

</script>
{% endblock %}